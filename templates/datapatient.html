{% extends "layout.html" %}

{% block title %}Home{% endblock title %}

{% block body %}
<link rel="stylesheet" href="/static/css/datapatient.css">

<!-- Page Header with Parallax effect -->
<header class="masthead" style="background-image: url('{{ url_for('static', filename='assets/img/heart5.jpg') }}'); height: 500px; background-attachment: fixed; background-size: cover;">
    <div class="container position-relative px-4 px-lg-5 h-100">
        <div class="row h-100 justify-content-center align-items-center">
            <div class="col-md-12 text-center">
                <div class="site-heading text-white" style="font-family: 'Montserrat', sans-serif;">
                    <h1 class="display-4 font-weight-bold">{{ params['blog_name'] }}</h1>
                    <p class="lead">Heart Failure Prediction System</p>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="container px-4 px-lg-5 mt-5">
    <!-- Export Buttons -->
    <div class="mb-4">
        <button class="btn btn-primary" id="exportPdfBtn">Export as PDF</button>
        <button class="btn btn-success" id="exportExcelBtn">Export as Excel</button>
    </div>

    <!-- Data Table with enhanced style -->
    <div class="table-responsive shadow-lg rounded">
        <table class="table table-hover align-middle table-striped table-bordered" id="dataTable">
            <thead class="thead-light bg-gradient text-white">
                <tr>
                    <th>#</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Chest Pain Type</th>
                    <th>Resting Blood Pressure</th>
                    <th>Cholesterol</th>
                    <th>Max Heart Rate</th>
                    <th>Exercise Angina</th>
                    <th>Blood Sugar</th>
                    <th>Diagnosis</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for record in data %}
                <tr class="hover-effect">
                    <td>{{ loop.index }}</td>
                    <td>{{ record[0] }}</td>
                    <td>{{ record[1] }}</td>
                    <td>{{ record[2] }}</td>
                    <td>{{ record[3] }}</td>
                    <td>{{ record[4] }}</td>
                    <td>{{ record[5] }}</td>
                    <td>{{ record[6] }}</td>
                    <td>{{ record[7] }}</td>
                    <td>{{ record[8] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination-container text-center mt-3">
        <button class="btn btn-secondary" id="prevPageBtn">Previous</button>
        <div id="pageNumbers" class="d-inline-block">
            <!-- Dynamic page numbers will appear here -->
        </div>
        <button class="btn btn-secondary" id="nextPageBtn">Next</button>
    </div>
</div>

<!-- Scroll to Top Button -->
<button id="scrollTopBtn" title="Go to top">&#8593;</button>

<!-- Scripts for Exporting PDF and Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script> <!-- Added autoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

<script src="/static/js/datapatient.js"></script>

<script>
    // Pagination Logic
    const rowsPerPage = 10;
    let currentPage = 1;

    // Sample data (Replace this with your actual data from Flask context)
    const tableRows = [...document.querySelectorAll('#dataTable tbody tr')];
    const totalRows = tableRows.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage);

    // Pagination Controls
    const pageNumbersContainer = document.getElementById('pageNumbers');

    // Function to update the table
    function updateTable() {
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        // Hide all rows first
        tableRows.forEach(row => row.style.display = 'none');

        // Show rows for the current page
        for (let i = start; i < end && i < totalRows; i++) {
            tableRows[i].style.display = '';
        }

        // Update page number display
        updatePageButtons();
    }

    // Function to update the page buttons (pagination controls)
    function updatePageButtons() {
        pageNumbersContainer.innerHTML = '';

        // Show previous and next buttons only if necessary
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');

        if (currentPage > 1) {
            prevBtn.disabled = false;
        } else {
            prevBtn.disabled = true;
        }

        if (currentPage < totalPages) {
            nextBtn.disabled = false;
        } else {
            nextBtn.disabled = true;
        }

        // Show page numbers depending on total pages
        let startPage = 1;
        let endPage = Math.min(totalPages, 5);

        if (totalPages > 5) {
            // If more than 5 pages, show a sliding window of page numbers
            startPage = currentPage <= 3 ? 1 : currentPage - 2;
            endPage = Math.min(totalPages, startPage + 4);
        }

        // Display page numbers
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.classList.add('btn', 'btn-outline-secondary', 'mx-1');
            pageBtn.textContent = i;

            // Highlight current page
            if (i === currentPage) {
                pageBtn.classList.add('active');
            }

            // Add event listener for page click
            pageBtn.addEventListener('click', function () {
                currentPage = i;
                updateTable();
            });

            pageNumbersContainer.appendChild(pageBtn);
        }
    }

    // Event listeners for pagination buttons
    document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    });

    document.getElementById('nextPageBtn').addEventListener('click', function() {
        if (currentPage < totalPages) {
            currentPage++;
            updateTable();
        }
    });

    // Initialize the table to show the first page of data
    updateTable();

    // PDF Export Function (Exports all rows, not just the current page)
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const table = document.getElementById('dataTable');

        // Use autoTable plugin to generate the table in PDF
        doc.autoTable({
            html: table,
            startY: 20, // Adjust to avoid header overlap
            theme: 'grid', // Optional: adjust table style (e.g., 'striped', 'grid', etc.)
        });

        doc.save('data.pdf');
    });

    // Excel Export Function (Exports all rows, not just the current page)
    document.getElementById('exportExcelBtn').addEventListener('click', function() {
        const table = document.getElementById('dataTable');
        const wb = XLSX.utils.table_to_book(table, { sheet: 'Sheet1' });
        XLSX.writeFile(wb, 'data.xlsx');
    });
</script>

{% endblock %}
